<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chart Annotation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link href="node_modules/label-studio/build/static/css/main.css" rel="stylesheet">
  <link rel="stylesheet" href="ui/dropzone/dist/min/dropzone.min.css">
</head>

<body>
  <div class="container-fluid py-4">
    <div id="drop" class="btn btn-primary">Upload</div>
    <div id="label-studio" class="pt-3"></div>
  </div>

  <script src="ui/jquery/dist/jquery.min.js"></script>
  <script src="ui/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="ui/lodash/lodash.min.js"></script>
  <script src="ui/g1/dist/g1.min.js"></script>
  <script src="node_modules/label-studio/build/static/js/main.js"></script>
  <script src="js/labelstudio.js"></script>
  <script src="ui/dropzone/dist/min/dropzone.min.js"></script>
  <!-- Commonly used libraries:
  <script src="ui/d3v5/dist/d3.min.js"></script>
  <script src="ui/morphdom/dist/morphdom-umd.min.js"></script>
  <script src="ui/moment/min/moment-with-locales.min.js"></script>
  <script src="ui/daterangepicker/daterangepicker.js"></script>
  <script src="ui/leaflet/dist/leaflet.js"></script>
  <script src="ui/topojson/dist/topojson.min.js"></script>
  -->
  <script>
    Dropzone.autoDiscover = false
    $('#drop').dropzone({
      url: '/screenshot',
      clickable: true,
      previewTemplate: '<div></div>',
      init: function () {
        this.on('success', function(file) {
          let {annotation, meta} = JSON.parse(file.xhr.response)
          render_labelstudio(annotation, meta,
                             "Jaidev", "Deshpande")
        })
      }
    })
    // var CLIPBOARD = new CLIPBOARD_CLASS("my_canvas", true);
    var CHART_TYPES = []

    /**
     * image pasting into canvas
     *
     * @param {string} canvas_id - canvas id
     * @param {boolean} autoresize - if canvas will be resized
     */
    // function CLIPBOARD_CLASS(canvas_id, autoresize) {
    //   var _self = this;
    //   var canvas = document.getElementById(canvas_id);
    //   var ctx = document.getElementById(canvas_id).getContext("2d");

    //   //handlers
    //   document.addEventListener('paste', function (e) { _self.paste_auto(e); }, false);

    //   //on paste
    //   this.paste_auto = function (e) {
    //     if (e.clipboardData) {
    //       var items = e.clipboardData.items;
    //       if (!items) return;

    //       //access data directly
    //       var is_image = false;
    //       for (var i = 0; i < items.length; i++) {
    //         if (items[i].type.indexOf("image") !== -1) {
    //           //image
    //           var blob = items[i].getAsFile();
    //           var URLObj = window.URL || window.webkitURL;
    //           var source = URLObj.createObjectURL(blob);
    //           this.paste_createImage(source);
    //           is_image = true;
    //         }
    //       }
    //       if(is_image == true){
    //         e.preventDefault();
    //       }
    //     }
    //   };
    //   //draw pasted image to canvas
    //   this.paste_createImage = function (source) {
    //     var pastedImage = new Image();
    //     pastedImage.onload = function () {
    //       if(autoresize == true){
    //         //resize
    //         canvas.width = pastedImage.width;
    //         canvas.height = pastedImage.height;
    //       }
    //       else{
    //         //clear canvas
    //         ctx.clearRect(0, 0, canvas.width, canvas.height);
    //       }
    //       ctx.drawImage(pastedImage, 0, 0);
    //     };
    //     pastedImage.src = source;
    //   };
    // }

  $('#imageMetaForm').on('submit', function(e) {
    e.preventDefault();
    let data = $(this).serializeArray()
    let imageEnc = document.getElementById('my_canvas').toDataURL()
    $.ajax({
      method: "POST", url: 'data',
      success: function() {
        location.reload()
      },
      data: {label: data[0].value, image: imageEnc}
    })
  })
  $(function() {
    fetch('uniq')
      .then(response => response.json())
      .then(function(data) {
        data = _.map(data, 'label')
        $.getJSON('chart_types.json').done(function(e) {
          CHART_TYPES = e
          $('body').template({CHART_TYPES: [...data, ...CHART_TYPES]})
        })
    })
  })
$('#chartForm').on('submit', function(e) {
  let $icon = $('<i class="fa fa-spinner fa-2x fa-fw align-middle"></i>').appendTo(this)
  e.preventDefault()
  let chart_url = $('#chartUrl').val()
  $.getJSON('screenshot?url=' + encodeURI(chart_url)).done(
    function(response) {
      var {annotation, meta} = response
      render_labelstudio(annotation, meta,
        "Jaidev", "Deshpande")
      $icon.fadeOut()
    }
  )
})
  </script>
</body>
</html>
